[env]
HCLOUD_TOKEN = "op://Private/quacttvsaylcxc3lhcvta7l2oy/password"
TF_VAR_hcloud_token = "{{ env.HCLOUD_TOKEN }}"
TF_VAR_ssh_key_name = "op://Private/6agth7vqswxvzx7lwmjqyzm25y/name"
K3S_TOKEN = "op://Private/Anchor-K3s-Cluster/credential"
# Created with `head -c 32 /dev/urandom | base64`
K3S_ETCD_SECRET = "op://Private/Anchor-K3s-Cluster/etcd_secret"
KUBECONFIG = "{{ config_root }}/kubeconfig"

# Cloudflare Configuration
TF_VAR_cloudflare_api_token = "op://Private/Anchor Cloudflare Config/credential"
TF_VAR_cloudflare_zone_id = "op://Private/Anchor Cloudflare Config/zone_id"
TF_VAR_domain = "op://Private/Anchor Cloudflare Config/domain"

# cert-manager Configuration
CERT_MANAGER_EMAIL = "op://Private/Anchor Cloudflare Config/email"

# Ansible Configuration
ANSIBLE_CONFIG = "{{ config_root }}/ansible/ansible.cfg"
ANSIBLE_FORCE_COLOR = "1"

# Authentik Secrets
AUTHENTIK_SECRET_KEY = "op://Private/Anchor Authentik Secrets/secret_key"
AUTHENTIK_DB_PASSWORD = "op://Private/Anchor Authentik Secrets/db_password"
AUTHENTIK_BOOTSTRAP_EMAIL = "op://Private/s4edwscvjopbjvcr44ri6iws74/username"
AUTHENTIK_BOOTSTRAP_PASSWORD = "op://Private/s4edwscvjopbjvcr44ri6iws74/password"

# SMTP Configuration (Resend.com)
AUTHENTIK_SMTP_HOST = "op://Private/Anchor SMTP Resend.com API Credentials/hostname"
AUTHENTIK_SMTP_PORT = "op://Private/Anchor SMTP Resend.com API Credentials/port"
AUTHENTIK_SMTP_USERNAME = "op://Private/Anchor SMTP Resend.com API Credentials/username"
AUTHENTIK_SMTP_PASSWORD = "op://Private/Anchor SMTP Resend.com API Credentials/credential"

NTFY_M2M_SECRET="op://Private/g62p55ou2jprzjawtkdracvngm/password"

[tools]
"opentofu" = "latest"
"pre-commit" = "3.8.0"
"pipx" = "latest"
"uv" = "latest"
"pipx:ansible-core" = { version = "latest", uvx_args = "--with requests --with hcloud" }
"kubectl" = "latest"
"yamllint" = "latest"
"hcloud" = "latest"  # Required for K3s resource cleanup on destroy
"helm" = "latest"

# Setup tasks
[tasks.setup]
description = "Setup project dependencies and initialize"
run = [
  "mise install",
  "mise run tofu:init",
  "mise run ansible:setup"
]

# OpenTofu tasks
[tasks."tofu:init"]
description = "Initialize OpenTofu configuration"
dir = "tofu"
run = "op run -- tofu init"

[tasks."tofu:plan"]
description = "Plan OpenTofu infrastructure changes"
dir = "tofu"
run = "op run -- tofu plan"

[tasks."tofu:apply"]
description = "Apply OpenTofu infrastructure changes"
dir = "tofu"
run = [
  "rm -rf /tmp/ansible_facts",
  "op run -- tofu apply"
]

[tasks."tofu:destroy"]
description = "Destroy OpenTofu infrastructure"
dir = "tofu"
run = "op run -- tofu destroy"

[tasks."tofu:validate"]
description = "Validate OpenTofu configuration"
dir = "tofu"
run = "op run -- tofu validate"

[tasks."tofu:fmt"]
description = "Format OpenTofu files"
dir = "tofu"
run = "tofu fmt"

[tasks."tofu:lint"]
description = "Lint and format all code"
dir = "tofu"
run = [
  "tofu fmt",
  "op run -- tofu validate"
]

[tasks."tofu:ip"]
description = "Get public IP of specific node"
usage = 'arg "<node_index>" help="Node index (0-2)" default="0"'
dir = "tofu"
run = 'tofu output -json node_public_ips | jq -r ".[${usage_node_index}]"'

[tasks."tofu:replace-nodes"]
description = "Replace all nodes with updated cloud-init configuration"
dir = "tofu"
run = [
  "rm -rf /tmp/ansible_facts",
  """
  op run -- tofu apply \
    -replace=hcloud_server.k3s_nodes[0] \
    -replace=hcloud_server.k3s_nodes[1] \
    -replace=hcloud_server.k3s_nodes[2]
  """
]

# Ansible tasks
[tasks."ansible:setup"]
description = "Install Ansible collections and dependencies"
dir = "ansible"
run = "ansible-galaxy install -r requirements.yml"

[tasks."ansible:inventory"]
description = "List Ansible inventory from Hetzner Cloud"
dir = "ansible"
run = "op run -- ansible-inventory --list"

[tasks."ansible:ping"]
description = "Test Ansible connectivity to all hosts"
dir = "ansible"
run = "op run -- ansible-playbook playbooks/maintenance/ping.yml"

[tasks."ansible:update-known-hosts"]
description = "Update SSH known_hosts with current server fingerprints"
dir = "ansible"
run = "op run -- ansible-playbook playbooks/maintenance/update-known-hosts.yml"

[tasks."ansible:run"]
description = "Run an Ansible playbook"
usage = 'arg "<playbook>" help="Path to playbook (e.g., playbooks/maintenance/ping.yml)"'
dir = "ansible"
run = "op run -- ansible-playbook ${usage_playbook}"

# Infrastructure deployment (full stack)
[tasks."ansible:deploy-k3s"]
description = "Deploy complete K3s infrastructure (cluster + integrations + cert-manager)"
dir = "ansible"
run = "op run -- ansible-playbook playbooks/01-infrastructure.yml"

# Infrastructure components (can run individually)
[tasks."ansible:deploy-cluster"]
description = "Deploy K3s HA cluster only"
dir = "ansible"
run = "op run -- ansible-playbook playbooks/infrastructure/k3s-cluster.yml"

[tasks."ansible:deploy-hcloud"]
description = "Deploy Hetzner Cloud integrations (CCM + CSI)"
dir = "ansible"
run = "op run -- ansible-playbook playbooks/infrastructure/hcloud-integrations.yml"

[tasks."ansible:deploy-cert-manager"]
description = "Deploy cert-manager with Let's Encrypt"
dir = "ansible"
run = "op run -- ansible-playbook playbooks/infrastructure/cert-manager.yml"

# Platform deployment
[tasks."ansible:deploy-platform"]
description = "Deploy platform services (database/identity)"
dir = "ansible"
run = "op run -- ansible-playbook playbooks/02-platform.yml"

[tasks."ansible:uninstall-k3s"]
description = "Uninstall K3s from all nodes"
dir = "ansible"
run = "op run -- ansible-playbook playbooks/maintenance/uninstall-k3s.yml"

# Full stack deployment
[tasks."deploy:full"]
description = "Deploy full stack: infrastructure + K3s + platform + developer tools"
run = """
op run -- bash -c '
  set -e
  echo "==> Clearing Ansible fact cache..."
  rm -rf /tmp/ansible_facts

  echo "==> Deploying infrastructure with OpenTofu..."
  tofu -chdir=tofu apply -auto-approve

  echo "==> Deploying K3s cluster + Hetzner integrations + cert-manager..."
  ansible-playbook ansible/playbooks/01-infrastructure.yml

  echo "==> Deploying platform services (database)..."
  ansible-playbook ansible/playbooks/02-platform.yml

  echo "==> Deploying developer tooling..."
  ansible-playbook ansible/playbooks/developer_tooling.yml

  echo "==> Full stack deployment complete!"
'
"""
