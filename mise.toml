[env]
TF_VAR_hcloud_token = "op://Private/quacttvsaylcxc3lhcvta7l2oy/password"
TF_VAR_ssh_key_name = "op://Private/6agth7vqswxvzx7lwmjqyzm25y/name"

[tools]
"opentofu" = "latest"
"pre-commit" = "3.8.0"

[tasks.init]
description = "Initialize OpenTofu configuration"
dir = "tofu"
run = "op run -- tofu init"

[tasks.plan]
description = "Plan OpenTofu infrastructure changes"
dir = "tofu"
run = "op run -- tofu plan"

[tasks.apply]
description = "Apply OpenTofu infrastructure changes"
dir = "tofu"
run = "op run -- tofu apply"

[tasks.destroy]
description = "Destroy OpenTofu infrastructure"
dir = "tofu"
run = "op run -- tofu destroy"

[tasks.validate]
description = "Validate OpenTofu configuration"
dir = "tofu"
run = "op run -- tofu validate"

[tasks.fmt]
description = "Format OpenTofu files"
dir = "tofu"
run = "tofu fmt"

[tasks.lint]
description = "Lint and format all code"
dir = "tofu"
run = [
  "tofu fmt",
  "op run -- tofu validate"
]

[tasks.setup]
description = "Setup project dependencies and initialize"
run = [
  "mise install",
  "mise run init"
]

[tasks.ip]
description = "Get public IP of specific node"
usage = 'arg "<node_index>" help="Node index (0-2)" default="0"'
dir = "tofu"
run = 'tofu output -json node_public_ips | jq -r ".[${usage_node_index}]"'

[tasks.replace-nodes]
description = "Replace all nodes with updated cloud-init configuration"
dir = "tofu"
run = [
  "op run -- tofu apply -replace=hcloud_server.k3s_nodes[0] -replace=hcloud_server.k3s_nodes[1] -replace=hcloud_server.k3s_nodes[2]",
  "op run -- tofu apply -replace=hcloud_floating_ip_assignment.k3s_floating_ip_assignment"
]
