#cloud-config

package_update: true
package_upgrade: true

packages:
  - curl
  - ca-certificates
  - open-iscsi
  - nfs-common
  - firewalld
  - fail2ban
  - libpam-google-authenticator

write_files:
  - path: /etc/ssh/sshd_config.d/99-security.conf
    content: |
      PasswordAuthentication no
    permissions: '0644'

runcmd:
  # Enable and start firewalld
  - systemctl enable firewalld
  - systemctl start firewalld
  
  # Configure firewalld rules
  - firewall-cmd --permanent --add-service=ssh
  - firewall-cmd --permanent --add-service=http
  - firewall-cmd --permanent --add-service=https
  - firewall-cmd --permanent --add-port=6443/tcp
  - firewall-cmd --permanent --zone=trusted --add-interface=ens10
  - firewall-cmd --reload
  
  # Enable and start fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban
  
  # Restart SSH service to apply new configuration
  - systemctl restart sshd
  
  # Enable and start open-iscsi for storage
  - systemctl enable open-iscsi
  - systemctl start open-iscsi

final_message: "Cloud-init setup complete. System ready for K3s installation."