---
- name: Ensure ntfy namespace exists
  kubernetes.core.k8s:
    name: "{{ ntfy_namespace }}"
    api_version: v1
    kind: Namespace
    state: present

- name: Deploy ntfy server configuration
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: ntfy-config
        namespace: "{{ ntfy_namespace }}"
      data:
        server.yml: "{{ lookup('template', 'server.yml.j2') }}"

- name: Deploy ntfy StatefulSet
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: ntfy
        namespace: "{{ ntfy_namespace }}"
        labels:
          app.kubernetes.io/name: ntfy
      spec:
        replicas: 1
        serviceName: ntfy
        selector:
          matchLabels:
            app.kubernetes.io/name: ntfy
        template:
          metadata:
            labels:
              app.kubernetes.io/name: ntfy
          spec:
            securityContext:
              runAsNonRoot: true
              runAsUser: 1000
              runAsGroup: 1000
              fsGroup: 1000
              seccompProfile:
                type: RuntimeDefault
            containers:
              - name: ntfy
                image: "{{ ntfy_image }}"
                args: ["serve"]
                securityContext:
                  allowPrivilegeEscalation: false
                  capabilities:
                    drop: ["ALL"]
                  readOnlyRootFilesystem: true
                ports:
                  - containerPort: 8080
                    name: http
                volumeMounts:
                  - name: config
                    mountPath: /etc/ntfy
                    readOnly: true
                  - name: cache
                    mountPath: /var/cache/ntfy
                resources:
                  requests:
                    cpu: 50m
                    memory: 64Mi
                  limits:
                    memory: 128Mi
                livenessProbe:
                  httpGet:
                    path: /v1/health
                    port: http
                  initialDelaySeconds: 5
                  periodSeconds: 30
                readinessProbe:
                  httpGet:
                    path: /v1/health
                    port: http
                  initialDelaySeconds: 5
                  periodSeconds: 10
            volumes:
              - name: config
                configMap:
                  name: ntfy-config
        volumeClaimTemplates:
          - metadata:
              name: cache
            spec:
              accessModes: ["ReadWriteOnce"]
              storageClassName: hcloud-volumes
              resources:
                requests:
                  storage: 1Gi

- name: Deploy ntfy Service
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: ntfy
        namespace: "{{ ntfy_namespace }}"
      spec:
        selector:
          app.kubernetes.io/name: ntfy
        ports:
          - port: 80
            targetPort: http
            protocol: TCP

- name: Deploy ntfy IngressRoute
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: traefik.io/v1alpha1
      kind: IngressRoute
      metadata:
        name: ntfy
        namespace: "{{ ntfy_namespace }}"
      spec:
        entryPoints:
          - websecure
        routes:
          - kind: Rule
            match: "Host(`{{ ntfy_domain }}`)"
            services:
              - kind: Service
                name: ntfy
                namespace: "{{ ntfy_namespace }}"
                port: 80
            middlewares:
              - name: authentik-forward-auth
                namespace: identity
        tls:
          secretName: "wildcard-{{ lookup('env', 'TF_VAR_domain') | replace('.', '-') }}-tls"
