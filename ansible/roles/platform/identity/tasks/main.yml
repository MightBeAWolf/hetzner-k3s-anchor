---
- name: Ensure Identity namespace exists
  kubernetes.core.k8s:
    name: "{{ authentik_namespace }}"
    api_version: v1
    kind: Namespace
    state: present

# --- WAIT FOR DATABASE CLUSTER ---
- name: Wait for CloudNativePG cluster to be healthy
  kubernetes.core.k8s_info:
    api_version: postgresql.cnpg.io/v1
    kind: Cluster
    name: main-db
    namespace: database
  register: cnpg_cluster
  until: >
    cnpg_cluster.resources | length > 0 and
    cnpg_cluster.resources[0].status is defined and
    cnpg_cluster.resources[0].status.phase is defined and
    cnpg_cluster.resources[0].status.phase == "Cluster in healthy state"
  retries: 30
  delay: 10

# --- DYNAMIC LEADER RESOLUTION ---
- name: Get Postgres Read-Write Endpoints
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Endpoints
    name: "main-db-rw"
    namespace: "database"
  register: db_rw_endpoints

- name: Fail if Read-Write Endpoint is empty
  ansible.builtin.fail:
    msg: "The main-db-rw service has no active endpoints."
  when: >
    db_rw_endpoints.resources | length == 0 or
    db_rw_endpoints.resources[0].subsets is not defined or
    db_rw_endpoints.resources[0].subsets | length == 0

- name: Set Fact for Postgres Leader Pod
  ansible.builtin.set_fact:
    authentik_db_admin_pod: "{{ db_rw_endpoints.resources[0].subsets[0].addresses[0].targetRef.name }}"

# --- DATABASE PROVISIONING (Refactored for Idempotency) ---

- name: Check if Authentik User Exists
  kubernetes.core.k8s_exec:
    namespace: "database"
    pod: "{{ authentik_db_admin_pod }}"
    command: psql -U postgres -tAc "SELECT 1 FROM pg_roles WHERE rolname='{{ authentik_db_user }}'"
  register: user_check
  changed_when: false

- name: Create Authentik User
  kubernetes.core.k8s_exec:
    namespace: "database"
    pod: "{{ authentik_db_admin_pod }}"
    command: psql -U postgres -c "CREATE ROLE {{ authentik_db_user }} WITH LOGIN PASSWORD '{{ authentik_db_password | string }}';"
  when: (user_check.stdout | trim) != '1'

- name: Check if Authentik Database Exists
  kubernetes.core.k8s_exec:
    namespace: "database"
    pod: "{{ authentik_db_admin_pod }}"
    command: psql -U postgres -tAc "SELECT 1 FROM pg_database WHERE datname='{{ authentik_db_name }}'"
  register: db_check
  changed_when: false

- name: Create Authentik Database
  kubernetes.core.k8s_exec:
    namespace: "database"
    pod: "{{ authentik_db_admin_pod }}"
    command: psql -U postgres -c "CREATE DATABASE {{ authentik_db_name }} OWNER {{ authentik_db_user }};"
  when: (db_check.stdout | trim) != '1'

# --- BLUEPRINTS ---
- name: Deploy Enrollment Invitation Blueprint ConfigMap
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: authentik-blueprints
        namespace: "{{ authentik_namespace }}"
        labels:
          app.kubernetes.io/name: authentik
      data:
        enrollment-invitation.yaml: "{{ lookup('template', 'blueprint-enrollment-invitation.yaml.j2') }}"
        recovery-email.yaml: "{{ lookup('template', 'blueprint-recovery-email.yaml.j2') }}"

# --- HELM DEPLOYMENT ---
- name: Add Authentik Helm Repo
  kubernetes.core.helm_repository:
    name: authentik
    repo_url: "{{ authentik_chart_repo }}"

- name: Deploy Authentik
  kubernetes.core.helm:
    name: authentik
    chart_ref: authentik/authentik
    release_namespace: "{{ authentik_namespace }}"
    chart_version: "{{ authentik_chart_version }}"
    values: "{{ lookup('template', 'values.yaml.j2') | from_yaml }}"
    wait: true
    wait_timeout: "15m"

- name: Wait for Authentik server deployment to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: authentik-server
    namespace: "{{ authentik_namespace }}"
  register: authentik_deploy
  until: >
    authentik_deploy.resources | length > 0 and
    authentik_deploy.resources[0].status.readyReplicas is defined and
    authentik_deploy.resources[0].status.readyReplicas == authentik_deploy.resources[0].spec.replicas
  retries: 30
  delay: 10
