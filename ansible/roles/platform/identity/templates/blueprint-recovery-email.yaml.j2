# Based on the official "Example - Recovery with email verification" blueprint
# https://github.com/goauthentik/authentik/blob/main/blueprints/example/flows-recovery-email-verification.yaml
#
# After applying, set this as the default recovery flow for your brand to
# enable the "Email recovery link" button in Directory > Users.
version: 1
metadata:
  labels:
    blueprints.goauthentik.io/instantiate: "true"
  name: Recovery with email verification
entries:
  # --- Flow ---
  - identifiers:
      slug: default-recovery-flow
    id: default-recovery-flow
    model: authentik_flows.flow
    attrs:
      name: Default recovery flow
      title: Reset your password
      designation: recovery
      authentication: require_unauthenticated

  # --- Policy: skip identification if user already restored ---
  - identifiers:
      name: default-recovery-skip-if-restored
    id: default-recovery-skip-if-restored
    model: authentik_policies_expression.expressionpolicy
    attrs:
      expression: |
        return not request.context.get('is_restored', False)

  # --- Email Stage ---
  - identifiers:
      name: default-recovery-email
    id: default-recovery-email
    model: authentik_stages_email.emailstage
    attrs:
      activate_user_on_success: true
      use_global_settings: true
      token_expiry: minutes=30
      subject: Password Reset
      template: email/password_reset.html
      recovery_max_attempts: 5
      recovery_cache_timeout: minutes=5

  # --- User Write Stage (never creates users) ---
  - identifiers:
      name: default-recovery-user-write
    id: default-recovery-user-write
    model: authentik_stages_user_write.userwritestage
    attrs:
      user_creation_mode: never_create

  # --- Identification Stage ---
  - identifiers:
      name: default-recovery-identification
    id: default-recovery-identification
    model: authentik_stages_identification.identificationstage
    attrs:
      user_fields:
        - email
        - username

  # --- User Login Stage ---
  - identifiers:
      name: default-recovery-user-login
    id: default-recovery-user-login
    model: authentik_stages_user_login.userloginstage

  # --- Flow Stage Bindings ---
  - identifiers:
      target: !KeyOf default-recovery-flow
      stage: !KeyOf default-recovery-identification
      order: 10
    model: authentik_flows.flowstagebinding
    id: flow-binding-identification
    attrs:
      evaluate_on_plan: true
      re_evaluate_policies: true
      policy_engine_mode: any
      invalid_response_action: retry

  - identifiers:
      target: !KeyOf default-recovery-flow
      stage: !KeyOf default-recovery-email
      order: 20
    model: authentik_flows.flowstagebinding
    id: flow-binding-email
    attrs:
      evaluate_on_plan: true
      re_evaluate_policies: true
      policy_engine_mode: any
      invalid_response_action: retry

  - identifiers:
      target: !KeyOf default-recovery-flow
      stage: !Find [authentik_stages_prompt.promptstage, [name, default-password-change-prompt]]
      order: 25
    model: authentik_flows.flowstagebinding
    attrs:
      evaluate_on_plan: true
      re_evaluate_policies: false
      policy_engine_mode: any
      invalid_response_action: retry

  - identifiers:
      target: !KeyOf default-recovery-flow
      stage: !Find [authentik_stages_user_write.userwritestage, [name, default-password-change-write]]
      order: 30
    model: authentik_flows.flowstagebinding
    attrs:
      evaluate_on_plan: true
      re_evaluate_policies: false
      policy_engine_mode: any
      invalid_response_action: retry

  - identifiers:
      target: !KeyOf default-recovery-flow
      stage: !KeyOf default-recovery-user-write
      order: 40
    model: authentik_flows.flowstagebinding
    attrs:
      evaluate_on_plan: true
      re_evaluate_policies: false
      policy_engine_mode: any
      invalid_response_action: retry

  - identifiers:
      target: !KeyOf default-recovery-flow
      stage: !KeyOf default-recovery-user-login
      order: 100
    model: authentik_flows.flowstagebinding
    attrs:
      evaluate_on_plan: true
      re_evaluate_policies: false
      policy_engine_mode: any
      invalid_response_action: retry

  # --- Policy Bindings ---
  - identifiers:
      policy: !KeyOf default-recovery-skip-if-restored
      target: !KeyOf flow-binding-identification
      order: 0
    model: authentik_policies.policybinding
    attrs:
      negate: false
      enabled: true
      timeout: 30

  - identifiers:
      policy: !KeyOf default-recovery-skip-if-restored
      target: !KeyOf flow-binding-email
      order: 0
    model: authentik_policies.policybinding
    attrs:
      negate: false
      enabled: true
      timeout: 30

  # --- Set as default brand recovery flow ---
  - identifiers:
      domain: authentik-default
      default: true
    model: authentik_brands.brand
    attrs:
      flow_recovery: !Find [authentik_flows.flow, [slug, default-recovery-flow]]
