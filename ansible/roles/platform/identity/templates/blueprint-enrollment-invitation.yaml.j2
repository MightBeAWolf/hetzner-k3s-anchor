# Simplified to a single invitation-gated enrollment flow.
# Example invitations removed â€” create invitations via the Admin UI.
version: 1
metadata:
  labels:
    blueprints.goauthentik.io/instantiate: "true"
  name: Link Invitation-based Enrollment
entries:
  # --- Flow ---
  - identifiers:
      slug: link-invitation-enrollment
    model: authentik_flows.flow
    id: invitation-enrollment-flow
    attrs:
      name: Invitation Enrollment Flow
      title: Welcome! Complete your enrollment
      designation: enrollment
      authentication: require_unauthenticated

  # --- Invitation Stage ---
  - identifiers:
      name: invitation-enrollment-invitation
    id: invitation-stage
    model: authentik_stages_invitation.invitationstage
    attrs:
      continue_flow_without_invitation: false

  # --- Prompt Fields ---
  - identifiers:
      name: invitation-enrollment-field-name
    id: prompt-field-name
    model: authentik_stages_prompt.prompt
    attrs:
      field_key: name
      label: Full Name
      type: text
      required: true
      placeholder: Name
      placeholder_expression: false
      order: 0

  - identifiers:
      name: invitation-enrollment-field-email
    id: prompt-field-email
    model: authentik_stages_prompt.prompt
    attrs:
      field_key: email
      label: Email
      type: email
      required: true
      placeholder: Email
      placeholder_expression: false
      order: 1

  - identifiers:
      name: invitation-enrollment-field-username
    id: prompt-field-username
    model: authentik_stages_prompt.prompt
    attrs:
      field_key: username
      label: Username
      type: username
      required: true
      placeholder: Username
      placeholder_expression: false
      order: 2

  - identifiers:
      name: invitation-enrollment-field-password
    id: prompt-field-password
    model: authentik_stages_prompt.prompt
    attrs:
      field_key: password
      label: Password
      type: password
      required: true
      placeholder: Password
      placeholder_expression: false
      order: 3

  - identifiers:
      name: invitation-enrollment-field-password-repeat
    id: prompt-field-password-repeat
    model: authentik_stages_prompt.prompt
    attrs:
      field_key: password_repeat
      label: Password (repeat)
      type: password
      required: true
      placeholder: Password (repeat)
      placeholder_expression: false
      order: 4

  # --- Prompt Stages ---
  - identifiers:
      name: invitation-enrollment-prompt-credentials
    id: prompt-stage-credentials
    model: authentik_stages_prompt.promptstage
    attrs:
      fields:
        - !KeyOf prompt-field-email
        - !KeyOf prompt-field-username
        - !KeyOf prompt-field-name
        - !KeyOf prompt-field-password
        - !KeyOf prompt-field-password-repeat
      validation_policies: 
        - !Find [authentik_policies_password.passwordpolicy, [name, default-password-policy]]

  # --- User Write Stage ---
  - identifiers:
      name: invitation-enrollment-user-write
    id: user-write-stage
    model: authentik_stages_user_write.userwritestage
    attrs:
      user_creation_mode: always_create
      user_type: internal
      user_path_template: users

  # --- Flow Stage Bindings ---
  - identifiers:
      target: !KeyOf invitation-enrollment-flow
      stage: !KeyOf invitation-stage
      order: 5
    model: authentik_flows.flowstagebinding
    attrs:
      evaluate_on_plan: true
      re_evaluate_policies: true

  - identifiers:
      target: !KeyOf invitation-enrollment-flow
      stage: !KeyOf prompt-stage-credentials
      order: 10
    model: authentik_flows.flowstagebinding

  - identifiers:
      target: !KeyOf invitation-enrollment-flow
      stage: !KeyOf user-write-stage
      order: 20
    model: authentik_flows.flowstagebinding

  - identifiers:
      target: !KeyOf invitation-enrollment-flow
      stage: !Find [authentik_stages_user_login.userloginstage, [name, default-source-enrollment-login]]
      order: 100
    model: authentik_flows.flowstagebinding
