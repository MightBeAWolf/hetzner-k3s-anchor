# Forward-auth proxy providers for applications behind Traefik.
# All forward-auth providers must be listed here so the embedded outpost
# providers list (which is REPLACED, not merged) stays complete.
version: 1
metadata:
  labels:
    blueprints.goauthentik.io/instantiate: "true"
  name: Forward Auth Applications
entries:
  # ============================================================
  # Traefik Dashboard
  # ============================================================
  - model: authentik_providers_proxy.proxyprovider
    state: present
    id: provider-traefik-dashboard
    identifiers:
      name: Traefik Dashboard
    attrs:
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
      mode: forward_single
      external_host: "https://{{ lookup('env', 'TF_VAR_domain') }}"

  - model: authentik_core.application
    state: present
    id: app-traefik-dashboard
    identifiers:
      slug: traefik-dashboard
    attrs:
      name: Traefik Dashboard
      provider: !KeyOf provider-traefik-dashboard
      meta_launch_url: "https://{{ lookup('env', 'TF_VAR_domain') }}/dashboard/"
      policy_engine_mode: any

  # ============================================================
  # Ntfy M2M (Machine-to-Machine)
  # ============================================================
  # Create the Service Account (User)
  - model: authentik_core.user
    state: present
    id: user-ntfy-m2m
    identifiers:
      username: ntfy-m2m-publisher
    attrs:
      name: ntfy-m2m-publisher
      path: service-accounts
      type: service_account
      is_active: true

  - model: authentik_core.token
    state: present
    identifiers:
      identifier: ntfy-m2m-token
    attrs:
      user: !Find [authentik_core.user, [username, ntfy-m2m-publisher]]
      key: "{{ lookup('env', 'NTFY_M2M_SECRET') }}"
      intent: api
      expiring: false
      description: Machine-to-machine API token for ntfy publisher

  # Create the OAuth2 Provider
  - model: authentik_providers_oauth2.oauth2provider
    state: present
    id: ntfy-oath2-provider
    identifiers:
      name: Ntfy OAuth2 Provider
    attrs:
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
      client_type: confidential
      client_id: ntfy-oauth2-provider
      client_secret: "{{ lookup('env', 'NTFY_M2M_SECRET') }}"
      signing_key: !Find [authentik_crypto.certificatekeypair, [name, "authentik Self-signed Certificate"]]
      redirect_uris: 
        - url: "https://ntfy.{{ lookup('env', 'TF_VAR_domain') }}"
          matching_mode: "strict"
      property_mappings:
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, "openid"]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, "email"]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, "profile"]]

  # Create the Application for M2M
  - model: authentik_core.application
    state: present
    id: app-ntfy-m2m
    identifiers:
      slug: ntfy-m2m
    attrs:
      name: Ntfy M2M
      provider: !KeyOf ntfy-oath2-provider
      policy_engine_mode: any

  # ============================================================
  # Ntfy Proxy
  # ============================================================
  - model: authentik_providers_proxy.proxyprovider
    state: present
    id: provider-ntfy
    identifiers:
      name: Ntfy Proxy Provider
    attrs:
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
      mode: forward_single
      intercept_header_auth: true
      external_host: "https://ntfy.{{ lookup('env', 'TF_VAR_domain') }}"
      jwt_federation_providers:
        - !KeyOf ntfy-oath2-provider

  - model: authentik_core.application
    state: present
    id: app-ntfy
    identifiers:
      slug: ntfy
    attrs:
      name: Ntfy
      provider: !KeyOf provider-ntfy
      meta_launch_url: "https://ntfy.{{ lookup('env', 'TF_VAR_domain') }}"
      policy_engine_mode: any
  # ============================================================
  # Embedded Outpost (all forward-auth providers)
  # ============================================================
  - model: authentik_outposts.outpost
    state: present
    identifiers:
      name: authentik Embedded Outpost
    attrs:
      type: proxy
      managed: goauthentik.io/outposts/embedded
      providers:
        - !Find [authentik_providers_proxy.proxyprovider, [name, "Traefik Dashboard"]]
        - !Find [authentik_providers_proxy.proxyprovider, [name, "Ntfy Proxy Provider"]]
      config:
        authentik_host: "https://auth.{{ lookup('env', 'TF_VAR_domain') }}"
