# yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
version: 1
metadata:
  labels:
    blueprints.goauthentik.io/instantiate: "true"
  name: Enforce MFA Authentication
entries:
  # --- Email OTP Setup Flow ---
  - model: authentik_flows.flow
    state: present
    id: flow-email-mfa-setup
    identifiers:
      slug: email-mfa-setup-flow
    attrs:
      name: email-mfa-setup-flow
      title: Configure Email OTP
      designation: stage_configuration
      authentication: require_authenticated

  # --- Email OTP Setup Stage ---
  - model: authentik_stages_authenticator_email.authenticatoremailstage
    state: present
    id: stage-email-mfa-setup
    identifiers:
      name: email-mfa-setup
    attrs:
      friendly_name: Email (One-Time Code)
      configure_flow: !KeyOf flow-email-mfa-setup
      use_global_settings: true
      subject: Your sign-in code
      template: email/email_otp.html
      token_expiry: minutes=10

  # --- MFA Validation Stage ---
  - model: authentik_stages_authenticator_validate.authenticatorvalidatestage
    state: present
    id: stage-auth-mfa-validate
    identifiers:
      name: default-authentication-mfa-validation
    attrs:
      not_configured_action: configure
      user_verification: required
      configuration_stages:
        - !Find [authentik_stages_authenticator_totp.authenticatortotpstage, [name, default-authenticator-totp-setup]]
        - !Find [authentik_stages_authenticator_webauthn.authenticatorwebauthnstage, [name, default-authenticator-webauthn-setup]]
        - !KeyOf stage-email-mfa-setup

  # --- Bind to invitation enrollment flow ---
  - model: authentik_flows.flowstagebinding
    state: present
    identifiers:
      target: !Find [authentik_flows.flow, [slug, link-invitation-enrollment]]
      stage: !KeyOf stage-auth-mfa-validate
      order: 25
    attrs:
      re_evaluate_policies: true
      policy_engine_mode: any
      invalid_response_action: retry

  # --- Move existing login stage to after MFA validation ---
  - model: authentik_flows.flowstagebinding
    state: present
    identifiers:
      target: !Find [authentik_flows.flow, [slug, default-source-enrollment]]
      stage: !Find [authentik_stages_user_login.userloginstage, [name, default-source-enrollment-login]]
    attrs:
      order: 3
      re_evaluate_policies: true
      policy_engine_mode: any
      invalid_response_action: retry

  # --- Insert MFA validation into source enrollment before login ---
  - model: authentik_flows.flowstagebinding
    state: present
    identifiers:
      target: !Find [authentik_flows.flow, [slug, default-source-enrollment]]
      stage: !KeyOf stage-auth-mfa-validate
      order: 2
    attrs:
      re_evaluate_policies: true
      policy_engine_mode: any
      invalid_response_action: retry

