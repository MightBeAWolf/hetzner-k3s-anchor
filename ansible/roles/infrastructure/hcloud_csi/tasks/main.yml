---
# Deploy Hetzner CSI Driver
# Required variables:
#   - hcloud_location: Hetzner location (from group_vars)

- name: Validate required variables
  ansible.builtin.assert:
    that:
      - hcloud_location is defined
    fail_msg: "Required variable: hcloud_location"

- name: Apply base HCloud CSI manifest
  kubernetes.core.k8s:
    state: present
    src: "{{ hcloud_csi_manifest_url }}"

- name: Apply custom labels and configuration overlay
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: hcloud-csi-controller
        namespace: kube-system
      spec:
        template:
          spec:
            containers:
              - name: hcloud-csi-driver
                env:
                  - name: HCLOUD_VOLUME_EXTRA_LABELS
                    value: "provisioner=k3s"
                  - name: HCLOUD_VOLUME_DEFAULT_LOCATION
                    value: "{{ hcloud_location }}"
