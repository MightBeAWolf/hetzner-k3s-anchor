---
# Fetch kubeconfig from K3s cluster and save locally
# Required variables:
#   - k3s_control_plane_endpoint: Load balancer IP
# Optional:
#   - kubeconfig_local_path: Where to save kubeconfig
#     Defaults to KUBECONFIG env var or ./kubeconfig in working directory

- name: Set kubeconfig path default
  ansible.builtin.set_fact:
    kubeconfig_local_path: >-
      {{ kubeconfig_local_path |
         default(lookup('env', 'KUBECONFIG') |
         default(playbook_dir + '/../../kubeconfig', true)) }}

- name: Fetch kubeconfig from node
  ansible.builtin.slurp:
    src: /etc/rancher/k3s/k3s.yaml
  register: kubeconfig_content
  no_log: true

- name: Save kubeconfig locally
  vars:
    kubeconfig_raw: "{{ kubeconfig_content.content | b64decode }}"
    kubeconfig_updated: >-
      {{ kubeconfig_raw | regex_replace(
        'https://127.0.0.1:6443',
        'https://' + k3s_control_plane_endpoint + ':6443'
      ) }}
  ansible.builtin.copy:
    content: "{{ kubeconfig_updated }}"
    dest: "{{ kubeconfig_local_path }}"
    mode: '0600'
  delegate_to: localhost
  become: false
  no_log: true

- name: Show cluster status
  ansible.builtin.command: k3s kubectl get nodes -o wide
  register: cluster_nodes
  changed_when: false

- name: Display nodes
  ansible.builtin.debug:
    msg: "{{ cluster_nodes.stdout_lines }}"
