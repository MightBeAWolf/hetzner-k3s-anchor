apiVersion: helm.cattle.io/v1
kind: HelmChartConfig
metadata:
  name: traefik
  namespace: kube-system
spec:
  valuesContent: |-
    hostNetwork: true

    deployment:
      kind: DaemonSet
      dnsPolicy: ClusterFirstWithHostNet

    service:
      type: ClusterIP

    updateStrategy:
      type: RollingUpdate
      rollingUpdate:
        maxUnavailable: 2
        maxSurge: 0

    securityContext:
      capabilities:
        drop: [ALL]
      runAsNonRoot: true
      runAsUser: 65532
      runAsGroup: 65532
      readOnlyRootFilesystem: true

    ports:
      web:
        port: 8080
        expose:
          default: true
        exposedPort: 80
        protocol: TCP
        proxyProtocol:
          trustedIPs:
            - 192.168.0.0/16
            - 10.42.0.0/16
        redirectTo:
          port: websecure
      websecure:
        port: 8443
        expose:
          default: true
        exposedPort: 443
        protocol: TCP
        proxyProtocol:
          trustedIPs:
            - 192.168.0.0/16
            - 10.42.0.0/16

    # Allow cross-namespace middleware references (e.g. identity namespace)
    providers:
      kubernetesCRD:
        allowCrossNamespace: true

    # Enable Traefik dashboard (secured by Authentik forward-auth)
    api:
      dashboard: true
      insecure: true

    ingressRoute:
      dashboard:
        enabled: true
        matchRule: Host(`{{ domain }}`) && (PathPrefix(`/dashboard`) || PathPrefix(`/api`))
        entryPoints:
          - websecure
        middlewares:
          - name: authentik-forward-auth
            namespace: identity
        tls:
          secretName: wildcard-{{ domain | replace('.', '-') }}-tls

    # TLS configuration - use wildcard cert from cert-manager as default
    tlsStore:
      default:
        defaultCertificate:
          secretName: wildcard-{{ domain | replace('.', '-') }}-tls

