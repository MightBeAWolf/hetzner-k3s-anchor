---
# Hetzner Cloud Dynamic Inventory
# Requires: ansible-galaxy collection install hetzner.hcloud
# Usage: HCLOUD_TOKEN=xxx ansible-inventory -i inventory/hcloud.yml --list
# Or via 1Password: op run --env-file=.env -- ansible-inventory -i inventory/hcloud.yml --list

plugin: hetzner.hcloud.hcloud

# Token from environment variable (injected via op run)
token_env: HCLOUD_TOKEN

# Filter servers by labels
filters:
  - label_selector == "project=anchor"
  - label_selector == "role=k3s-node"

# Compose variables for each host
compose:
  # Use public IPv4 for SSH connections
  ansible_host: ipv4_address

# Create Ansible groups based on labels and attributes
groups:
  # Group all k3s nodes
  k3s_nodes: hcloud_labels.role == "k3s-node"

  # Group by environment
  production: hcloud_labels.environment == "production"

  # Group by project
  anchor: hcloud_labels.project == "anchor"

  # Group by location (for future multi-region)
  hel1: hcloud_location == "hel1"

# Create keyed groups for dynamic grouping
keyed_groups:
  # Group by server type (e.g., type_cx23)
  - key: hcloud_server_type
    prefix: type
    separator: "_"

  # Group by status (e.g., status_running)
  - key: hcloud_status
    prefix: status
    separator: "_"

  # Group by location (e.g., location_hel1)
  - key: hcloud_location
    prefix: location
    separator: "_"
