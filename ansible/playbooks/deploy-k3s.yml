---
# Deploy K3s HA cluster with embedded etcd
# Run with: mise run ansible:deploy-k3s

- name: Pre-deployment - Fetch dynamic variables
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Verify K3S_TOKEN is set
      ansible.builtin.assert:
        that:
          - lookup('env', 'K3S_TOKEN') | length > 0
        fail_msg: "K3S_TOKEN environment variable must be set"

    - name: Verify K3S_ETCD_SECRET is set
      ansible.builtin.assert:
        that:
          - lookup('env', 'K3S_ETCD_SECRET') | length > 0
        fail_msg: "K3S_ETCD_SECRET environment variable must be set"

    - name: Fetch Load Balancer from Hetzner Cloud
      hetzner.hcloud.load_balancer_info:
        label_selector: "project=anchor,role=k3s-control-plane"
      register: hcloud_load_balancers
      no_log: true

    - name: Verify Load Balancer found
      ansible.builtin.assert:
        that:
          - hcloud_load_balancers.hcloud_load_balancer_info | length == 1
        fail_msg: "Expected 1 Load Balancer with project=anchor,role=k3s-control-plane"

    - name: Set Load Balancer IP fact
      ansible.builtin.set_fact:
        k3s_control_plane_endpoint: "{{ hcloud_load_balancers.hcloud_load_balancer_info[0].ipv4_address }}"
        cacheable: true

    - name: Fetch Hetzner Cloud Network
      hetzner.hcloud.network_info:
        label_selector: "project=anchor"
      register: hcloud_networks
      no_log: true

    - name: Verify network found
      ansible.builtin.assert:
        that:
          - hcloud_networks.hcloud_network_info | length == 1
        fail_msg: "Expected 1 network with project=anchor"

    - name: Set network fact
      ansible.builtin.set_fact:
        hcloud_network_name: "{{ hcloud_networks.hcloud_network_info[0].name }}"
        cacheable: true

    - name: Display configuration
      ansible.builtin.debug:
        msg: "Control Plane: {{ k3s_control_plane_endpoint }} | Network: {{ hcloud_network_name }}"

- name: Initialize K3s Cluster
  hosts: k3s-converged-node-01
  become: true
  gather_facts: true
  vars:
    k3s_control_plane_endpoint: "{{ hostvars['localhost']['k3s_control_plane_endpoint'] }}"
  vars_files:
    - vars/k3s-server-args.yml

  pre_tasks:
    - name: Wait for cloud-init to complete
      ansible.builtin.command: cloud-init status --wait
      changed_when: false
      timeout: 300

    - name: Verify system requirements
      ansible.builtin.assert:
        that:
          - ansible_facts['memtotal_mb'] >= 1024
          - ansible_facts['distribution'] == 'Debian'
          - ansible_facts['mounts'] | selectattr('mount', 'equalto', '/') | map(attribute='size_available') | first > 5368709120
        fail_msg: "System requirements not met (1GB RAM, Debian, 5GB disk)"

  tasks:
    - name: Setup K3s server prerequisites
      ansible.builtin.include_tasks: tasks/k3s-server-prereqs.yml

    - name: Install K3s server (cluster init)
      ansible.builtin.command:
        cmd: >
          /tmp/k3s-install.sh server
          --cluster-init
          --node-ip={{ hcloud_private_networks[0]['ip'] }}
          --tls-san={{ k3s_control_plane_endpoint }}
          --tls-san={{ hcloud_private_networks[0]['ip'] }}
          --tls-san={{ ansible_host }}
          --kube-apiserver-arg=encryption-provider-config={{ k3s_encryption_config.dest }}
          {{ k3s_common_args }}
      environment:
        INSTALL_K3S_VERSION: "{{ k3s_version }}"
        K3S_TOKEN: "{{ lookup('env', 'K3S_TOKEN') }}"
      when: not k3s_binary.stat.exists
      no_log: true

    - name: Wait for K3s to be ready
      ansible.builtin.wait_for:
        path: /etc/rancher/k3s/k3s.yaml
        timeout: 120

    - name: Wait for node to be ready
      ansible.builtin.command: k3s kubectl wait --for=condition=Ready node/{{ inventory_hostname }} --timeout=120s
      changed_when: false
      retries: 5
      delay: 10
      register: node_ready
      until: node_ready is success

    - name: Verify K3s service is running
      ansible.builtin.systemd:
        name: k3s
        state: started
        enabled: true

    - name: Clean up installation script
      ansible.builtin.file:
        path: /tmp/k3s-install.sh
        state: absent

- name: Join Additional Nodes
  hosts: k3s_nodes:!k3s-converged-node-01
  become: true
  gather_facts: true
  serial: 1
  vars:
    k3s_control_plane_endpoint: "{{ hostvars['localhost']['k3s_control_plane_endpoint'] }}"
  vars_files:
    - vars/k3s-server-args.yml

  pre_tasks:
    - name: Wait for cloud-init to complete
      ansible.builtin.command: cloud-init status --wait
      changed_when: false
      timeout: 300

    - name: Verify system requirements
      ansible.builtin.assert:
        that:
          - ansible_facts['memtotal_mb'] >= 1024
          - ansible_facts['distribution'] == 'Debian'
          - ansible_facts['mounts'] | selectattr('mount', 'equalto', '/') | map(attribute='size_available') | first > 5368709120
        fail_msg: "System requirements not met (1GB RAM, Debian, 5GB disk)"

  tasks:
    - name: Wait for first node API
      ansible.builtin.wait_for:
        host: "{{ hostvars[k3s_cluster_init_node]['hcloud_private_networks'][0]['ip'] }}"
        port: 6443
        timeout: 300

    - name: Setup K3s server prerequisites
      ansible.builtin.include_tasks: tasks/k3s-server-prereqs.yml

    - name: Check if node is already in cluster
      ansible.builtin.command: k3s kubectl get node {{ inventory_hostname }}
      register: node_in_cluster
      changed_when: false
      failed_when: false
      delegate_to: "{{ k3s_cluster_init_node }}"

    - name: Join as server node
      ansible.builtin.command:
        cmd: >
          /tmp/k3s-install.sh server
          --server https://{{ hostvars[k3s_cluster_init_node]['hcloud_private_networks'][0]['ip'] }}:6443
          --node-ip={{ hcloud_private_networks[0]['ip'] }}
          --tls-san={{ k3s_control_plane_endpoint }}
          --tls-san={{ ansible_host }}
          --kube-apiserver-arg=encryption-provider-config={{ k3s_encryption_config.dest }}
          {{ k3s_common_args }}
      environment:
        INSTALL_K3S_VERSION: "{{ k3s_version }}"
        K3S_TOKEN: "{{ lookup('env', 'K3S_TOKEN') }}"
      when: node_in_cluster.rc != 0

    - name: Wait for node to be ready
      ansible.builtin.command: k3s kubectl wait --for=condition=Ready node/{{ inventory_hostname }} --timeout=120s
      changed_when: false
      retries: 5
      delay: 10
      register: node_ready
      until: node_ready is success
      delegate_to: "{{ k3s_cluster_init_node }}"

    - name: Verify K3s service is running
      ansible.builtin.systemd:
        name: k3s
        state: started
        enabled: true

    - name: Clean up installation script
      ansible.builtin.file:
        path: /tmp/k3s-install.sh
        state: absent

- name: Retrieve kubeconfig
  hosts: k3s-converged-node-01
  become: true
  gather_facts: false
  vars:
    k3s_control_plane_endpoint: "{{ hostvars['localhost']['k3s_control_plane_endpoint'] }}"
  tasks:
    - name: Fetch kubeconfig
      ansible.builtin.slurp:
        src: /etc/rancher/k3s/k3s.yaml
      register: kubeconfig_content
      no_log: true

    - name: Save kubeconfig locally
      ansible.builtin.copy:
        content: "{{ kubeconfig_content.content | b64decode | regex_replace('https://127.0.0.1:6443', 'https://' + k3s_control_plane_endpoint + ':6443') }}"
        dest: "{{ playbook_dir }}/../../kubeconfig"
        mode: '0600'
      delegate_to: localhost
      become: false
      no_log: true

    - name: Show cluster status
      ansible.builtin.command: k3s kubectl get nodes -o wide
      register: cluster_nodes
      changed_when: false

    - name: Display nodes
      ansible.builtin.debug:
        msg: "{{ cluster_nodes.stdout_lines }}"

- name: Deploy Hetzner Cloud Controller Manager
  hosts: k3s-converged-node-01
  become: true
  gather_facts: false
  vars:
    hcloud_network_name: "{{ hostvars['localhost']['hcloud_network_name'] }}"
  tasks:
    - name: Create temp directory for CCM
      ansible.builtin.tempfile:
        state: directory
        prefix: ccm_
      register: ccm_temp_dir

    - name: Template CCM manifests
      ansible.builtin.template:
        src: "{{ item.src }}"
        dest: "{{ ccm_temp_dir.path }}/{{ item.dest }}"
        mode: '0600'
      loop:
        - { src: 'ccm/00-hcloud-secret.yaml.j2', dest: '00-hcloud-secret.yaml' }
        - { src: 'ccm/10-hcloud-ccm.yaml.j2', dest: '10-hcloud-ccm.yaml' }
      no_log: true

    - name: Apply CCM manifests
      ansible.builtin.command:
        cmd: k3s kubectl apply -f {{ ccm_temp_dir.path }}/
      register: ccm_apply
      changed_when: "'created' in ccm_apply.stdout or 'configured' in ccm_apply.stdout"

    - name: Clean up temp directory
      ansible.builtin.file:
        path: "{{ ccm_temp_dir.path }}"
        state: absent
      no_log: true

    - name: Wait for CCM rollout
      ansible.builtin.command:
        cmd: k3s kubectl rollout status deployment/hcloud-cloud-controller-manager -n kube-system --timeout=120s
      changed_when: false
      retries: 3
      delay: 10

- name: Deploy Hetzner CSI Driver
  hosts: k3s-converged-node-01
  become: true
  gather_facts: false
  tasks:
    - name: Deploy CSI Driver
      ansible.builtin.command:
        cmd: kubectl apply -f https://raw.githubusercontent.com/hetznercloud/csi-driver/v2.13.0/deploy/kubernetes/hcloud-csi.yml
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        HCLOUD_VOLUME_DEFAULT_LOCATION: "{{ hcloud_location }}"
      register: csi_install
      changed_when: "'created' in csi_install.stdout or 'configured' in csi_install.stdout"

- name: Deploy cert-manager
  hosts: k3s-converged-node-01
  become: true
  gather_facts: false
  tasks:
    - name: Deploy cert-manager Helm chart
      ansible.builtin.template:
        src: cert-manager/10-helm-chart.yaml.j2
        dest: /var/lib/rancher/k3s/server/manifests/cert-manager.yaml
        owner: root
        group: root
        mode: '0600'

    - name: Wait for cert-manager namespace
      ansible.builtin.command:
        cmd: k3s kubectl wait --for=jsonpath='{.status.phase}'=Active namespace/cert-manager --timeout=120s
      changed_when: false
      retries: 10
      delay: 10
      register: ns_ready
      until: ns_ready is success

    - name: Wait for cert-manager webhook to be ready
      ansible.builtin.command:
        cmd: k3s kubectl wait --for=condition=Available deployment/cert-manager-webhook -n cert-manager --timeout=180s
      changed_when: false
      retries: 5
      delay: 15
      register: webhook_ready
      until: webhook_ready is success

    - name: Create temp directory for cert-manager config
      ansible.builtin.tempfile:
        state: directory
        prefix: certmanager_
      register: certmanager_temp_dir

    - name: Template cert-manager configuration
      ansible.builtin.template:
        src: "{{ item.src }}"
        dest: "{{ certmanager_temp_dir.path }}/{{ item.dest }}"
        mode: '0600'
      loop:
        - { src: 'cert-manager/20-cloudflare-secret.yaml.j2', dest: '20-cloudflare-secret.yaml' }
        - { src: 'cert-manager/30-cluster-issuer.yaml.j2', dest: '30-cluster-issuer.yaml' }
        - { src: 'cert-manager/40-wildcard-certificate.yaml.j2', dest: '40-wildcard-certificate.yaml' }
      no_log: true

    - name: Apply cert-manager configuration
      ansible.builtin.command:
        cmd: k3s kubectl apply -f {{ certmanager_temp_dir.path }}/
      register: certmanager_apply
      changed_when: "'created' in certmanager_apply.stdout or 'configured' in certmanager_apply.stdout"

    - name: Clean up temp directory
      ansible.builtin.file:
        path: "{{ certmanager_temp_dir.path }}"
        state: absent
      no_log: true

    - name: Wait for wildcard certificate to be ready
      ansible.builtin.command:
        cmd: k3s kubectl wait --for=condition=Ready certificate/wildcard-{{ domain | replace('.', '-') }} -n kube-system --timeout=300s
      changed_when: false
      retries: 3
      delay: 30
      register: cert_ready
      until: cert_ready is success

- name: Post-deployment
  hosts: localhost
  gather_facts: false
  vars:
    k3s_control_plane_endpoint: "{{ hostvars['localhost']['k3s_control_plane_endpoint'] }}"
  tasks:
    - name: Display next steps
      ansible.builtin.debug:
        msg: |
          K3s cluster deployed
          Kubeconfig: ./kubeconfig
          API Endpoint: {{ k3s_control_plane_endpoint }}:6443

          Next steps:
          1. export KUBECONFIG=./kubeconfig
          2. kubectl get nodes
          3. kubectl apply -f manifests/whoami.yaml
          4. curl https://whoami.{{ domain }}
