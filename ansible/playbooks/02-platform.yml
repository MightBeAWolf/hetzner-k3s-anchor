---
- name: Phase 2 - Platform Layer
  hosts: k3s_nodes
  run_once: true
  become: true

  module_defaults:
    kubernetes.core.helm:
      kubeconfig: /etc/rancher/k3s/k3s.yaml
    kubernetes.core.k8s:
      kubeconfig: /etc/rancher/k3s/k3s.yaml
    kubernetes.core.helm_repository:
      kubeconfig: /etc/rancher/k3s/k3s.yaml
    kubernetes.core.k8s_info:
      kubeconfig: /etc/rancher/k3s/k3s.yaml
    kubernetes.core.k8s_exec:
      kubeconfig: /etc/rancher/k3s/k3s.yaml

  roles:
    - role: platform/database
      tags: ['database']
    - role: platform/identity
      tags: ['identity', 'auth', 'authentik']
    - role: platform/ntfy
      tags: ['ntfy']

  tasks:
    - name: Deploy Matrix using Helm
      kubernetes.core.helm:
        release_name: matrix-chart
        release_namespace: default
        chart_ref: "{{ playbook_dir }}/../../charts/matrix"
        wait: true
        kubeconfig: "{{ lookup('env', 'KUBECONFIG') }}"
      become: false
      tags: ['matrix']
      delegate_to: localhost
      run_once: true
